name: Cordova Android Build and Release

on:
  push:
    branches: [ main, master ]
    tags: [ 'v*' ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:  # Allow manual triggers

jobs:
  build-android:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
    
    - name: Setup Java 17 (required for Android SDK)
      uses: actions/setup-java@v4
      with:
        distribution: 'temurin'
        java-version: '17'
    
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'
    
    - name: Install Cordova CLI
      run: |
        npm install -g cordova
    
    - name: Install Android SDK (manual setup)
      run: |
        # Create Android SDK directory
        mkdir -p /usr/local/lib/android/sdk
        
        # Download and extract Android Command Line Tools
        cd /tmp
        wget -q https://dl.google.com/android/repository/commandlinetools-linux-11076708_latest.zip -O cmdline-tools.zip
        mkdir -p /usr/local/lib/android/sdk/cmdline-tools
        unzip -q cmdline-tools.zip -d /usr/local/lib/android/sdk/cmdline-tools
        mv /usr/local/lib/android/sdk/cmdline-tools/cmdline-tools /usr/local/lib/android/sdk/cmdline-tools/latest
        
        # Set environment variables
        echo "ANDROID_HOME=/usr/local/lib/android/sdk" >> $GITHUB_ENV
        echo "ANDROID_SDK_ROOT=/usr/local/lib/android/sdk" >> $GITHUB_ENV
        echo "PATH=/usr/local/lib/android/sdk/cmdline-tools/latest/bin:/usr/local/lib/android/sdk/platform-tools:$PATH" >> $GITHUB_ENV
    
    - name: Accept Android licenses
      run: |
        yes | sdkmanager --licenses || true
    
    - name: Install Android build tools
      run: |
        sdkmanager "platform-tools"
        sdkmanager "platforms;android-33"
        sdkmanager "build-tools;33.0.0"
        sdkmanager "platforms;android-34"
        sdkmanager "build-tools;34.0.0"
    
    - name: Check project structure
      run: |
        echo "Current directory: $(pwd)"
        echo "Directory contents:"
        ls -la
        echo "Looking for Cordova files:"
        find . -name "config.xml" -o -name "package.json" | head -10
    
    - name: Install project dependencies
      run: |
        # Check if we're in wrapper directory
        if [ -f "config.xml" ]; then
          echo "Found config.xml in current directory"
          DIR="."
        elif [ -f "wrapper/config.xml" ]; then
          echo "Found config.xml in wrapper directory"
          cd wrapper
          DIR="wrapper"
        else
          echo "Error: Could not find config.xml"
          exit 1
        fi
        
        echo "Working in directory: $(pwd)"
        
        # Install dependencies
        if [ -f "package.json" ]; then
          npm install
        else
          echo "No package.json found, creating minimal one"
          cat > package.json << 'EOF'
{
  "name": "com.datasell.app",
  "version": "1.0.0",
  "description": "DataSell App",
  "main": "index.js",
  "scripts": {
    "test": "echo \"Error: no test specified\" && exit 1"
  },
  "author": "",
  "license": "ISC"
}
EOF
          npm install cordova-android@14.0.1
        fi
        
        # Initialize Cordova project
        if [ ! -d "platforms" ]; then
          echo "Adding Android platform..."
          cordova platform add android@14.0.1
        else
          echo "Android platform already exists"
        fi
    
    - name: Install ImageMagick for logo processing
      run: |
        sudo apt-get update
        sudo apt-get install -y imagemagick
    
    - name: Copy logo and bundle public folder
      run: |
        # Determine working directory
        if [ -f "config.xml" ]; then
          WORK_DIR="."
        elif [ -f "wrapper/config.xml" ]; then
          cd wrapper
          WORK_DIR="wrapper"
        fi
        
        echo "Working in: $(pwd)"
        
        # Create images directory
        mkdir -p www/images
        
        # Copy logo (try multiple locations)
        LOGO_FOUND=false
        for LOGO_PATH in "../public/images/web-logo2.png" "../../public/images/web-logo2.png" "public/images/web-logo2.png"; do
          if [ -f "$LOGO_PATH" ]; then
            cp "$LOGO_PATH" "www/images/web-logo2.png"
            echo "âœ“ Copied logo from: $LOGO_PATH"
            LOGO_FOUND=true
            break
          fi
        done
        
        if [ "$LOGO_FOUND" = false ]; then
          echo "âš  Warning: Logo not found, creating placeholder"
          convert -size 1024x1024 xc:#4A90E2 -pointsize 100 -fill white -gravity center -draw "text 0,0 'DS'" www/images/web-logo2.png 2>/dev/null || echo "Placeholder creation failed"
        fi
        
        # Copy public folder
        PUBLIC_FOUND=false
        for PUBLIC_PATH in "../public" "../../public" "public"; do
          if [ -d "$PUBLIC_PATH" ]; then
            echo "Copying public folder from: $PUBLIC_PATH"
            rm -rf www/app
            mkdir -p www/app
            cp -r "$PUBLIC_PATH"/. www/app/
            echo "âœ“ Public folder copied"
            PUBLIC_FOUND=true
            break
          fi
        done
        
        if [ "$PUBLIC_FOUND" = false ]; then
          echo "âš  Warning: No public folder found"
        fi
        
        # Create necessary directories
        mkdir -p www/app/downloads
        mkdir -p platforms/android/app/build/outputs/apk/ 2>/dev/null || true
    
    - name: Build Debug APK
      run: |
        # Determine working directory
        if [ -f "config.xml" ]; then
          :
        elif [ -f "wrapper/config.xml" ]; then
          cd wrapper
        fi
        
        echo "Building debug APK..."
        cordova build android --debug \
          -- --no-daemon \
          -Dorg.gradle.jvmargs="-Xmx1200m -Dfile.encoding=UTF-8"
        echo "Debug APK built"
    
    - name: Copy debug APK for distribution
      run: |
        # Determine working directory
        if [ -f "config.xml" ]; then
          WORK_DIR="."
        elif [ -f "wrapper/config.xml" ]; then
          cd wrapper
          WORK_DIR="wrapper"
        fi
        
        mkdir -p dist/debug
        APK_PATH="platforms/android/app/build/outputs/apk/debug/app-debug.apk"
        
        if [ -f "$APK_PATH" ]; then
          cp "$APK_PATH" "dist/debug/datasell-debug.apk"
          echo "Debug APK copied to dist/debug/"
          
          # Also copy to root dist for easy access
          mkdir -p ../../dist/debug 2>/dev/null || mkdir -p ../dist/debug
          cp "$APK_PATH" "../../dist/debug/datasell-debug.apk" 2>/dev/null || cp "$APK_PATH" "../dist/debug/datasell-debug.apk"
          
          APK_SIZE=$(stat -c%s "$APK_PATH")
          APK_SIZE_MB=$(echo "scale=2; $APK_SIZE / 1048576" | bc)
          echo "Debug APK size: ${APK_SIZE_MB} MB"
          echo "debug_apk_size_mb=${APK_SIZE_MB}" >> $GITHUB_ENV
        else
          echo "âŒ Debug APK not found at: $APK_PATH"
          echo "Available APKs:"
          find . -name "*.apk" 2>/dev/null || true
        fi
    
    - name: Prepare keystore for signing
      if: github.event_name == 'push' && (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master' || startsWith(github.ref, 'refs/tags/'))
      run: |
        # Determine working directory
        if [ -f "config.xml" ]; then
          :
        elif [ -f "wrapper/config.xml" ]; then
          cd wrapper
        fi
        
        if [ -n "${{ secrets.ANDROID_KEYSTORE_BASE64 }}" ]; then
          echo "ðŸ” Setting up keystore..."
          echo "${{ secrets.ANDROID_KEYSTORE_BASE64 }}" | base64 --decode > android-release.keystore
          
          cat > keystore.properties << EOF
storeFile=android-release.keystore
storePassword=${{ secrets.ANDROID_KEYSTORE_PASSWORD }}
keyAlias=${{ secrets.ANDROID_KEY_ALIAS }}
keyPassword=${{ secrets.ANDROID_KEY_PASSWORD }}
EOF
          echo "âœ“ Keystore setup complete"
        else
          echo "âš  No keystore secret found"
        fi
    
    - name: Build Release APK
      if: github.event_name == 'push' && (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master' || startsWith(github.ref, 'refs/tags/'))
      run: |
        # Determine working directory
        if [ -f "config.xml" ]; then
          :
        elif [ -f "wrapper/config.xml" ]; then
          cd wrapper
        fi
        
        if [ -f "keystore.properties" ]; then
          echo "ðŸ”¨ Building release APK..."
          cordova build android --release \
            -- --no-daemon \
            -Dorg.gradle.jvmargs="-Xmx1200m -Dfile.encoding=UTF-8"
          
          RELEASE_APK="platforms/android/app/build/outputs/apk/release/app-release.apk"
          SIGNED_APK="dist/release/datasell-release-${{ github.sha }}.apk"
          
          if [ -f "$RELEASE_APK" ]; then
            echo "âœ“ Release APK built"
            mkdir -p dist/release
            
            # Sign APK
            jarsigner -verbose -sigalg SHA256withRSA -digestalg SHA-256 \
              -keystore android-release.keystore \
              -storepass "${{ secrets.ANDROID_KEYSTORE_PASSWORD }}" \
              -keypass "${{ secrets.ANDROID_KEY_PASSWORD }}" \
              "$RELEASE_APK" "${{ secrets.ANDROID_KEY_ALIAS }}"
            
            # Align APK
            $ANDROID_SDK_ROOT/build-tools/34.0.0/zipalign -v 4 "$RELEASE_APK" "$SIGNED_APK"
            $ANDROID_SDK_ROOT/build-tools/34.0.0/zipalign -c 4 "$SIGNED_APK"
            
            echo "âœ“ APK signed and aligned"
            
            # Copy to root dist
            mkdir -p ../../dist/release 2>/dev/null || mkdir -p ../dist/release
            cp "$SIGNED_APK" "../../dist/release/" 2>/dev/null || cp "$SIGNED_APK" "../dist/release/"
            
            APK_SIZE=$(stat -c%s "$SIGNED_APK")
            APK_SIZE_MB=$(echo "scale=2; $APK_SIZE / 1048576" | bc)
            echo "release_apk_size_mb=${APK_SIZE_MB}" >> $GITHUB_ENV
            
          else
            echo "âŒ Release APK not found"
            find . -name "*.apk" 2>/dev/null || true
            exit 1
          fi
        else
          echo "âš  Skipping release build"
        fi
    
    - name: Upload debug APK as artifact
      uses: actions/upload-artifact@v4
      with:
        name: debug-apk
        path: |
          dist/debug/*.apk
          wrapper/dist/debug/*.apk
        if-no-files-found: ignore
    
    - name: Upload release APK as artifact
      if: github.event_name == 'push' && (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master' || startsWith(github.ref, 'refs/tags/'))
      uses: actions/upload-artifact@v4
      with:
        name: release-apk
        path: |
          dist/release/*.apk
          wrapper/dist/release/*.apk
        if-no-files-found: ignore
    
    - name: Extract version info
      id: version-info
      run: |
        # Find config.xml
        if [ -f "config.xml" ]; then
          CONFIG_FILE="config.xml"
        elif [ -f "wrapper/config.xml" ]; then
          CONFIG_FILE="wrapper/config.xml"
        else
          echo "Error: config.xml not found"
          exit 1
        fi
        
        VERSION=$(grep -o 'version="[^"]*"' "$CONFIG_FILE" | head -1 | sed 's/version="//;s/"//' || echo "1.0.0")
        APP_NAME=$(grep -o '<name>[^<]*</name>' "$CONFIG_FILE" | head -1 | sed 's/<name>//;s/</name>//' || echo "DataSellApp")
        
        echo "version=$VERSION" >> $GITHUB_OUTPUT
        echo "app_name=$APP_NAME" >> $GITHUB_OUTPUT
        echo "build_date=$(date -u +'%Y-%m-%d %H:%M:%S UTC')" >> $GITHUB_OUTPUT
        
        SHORT_SHA=$(echo ${{ github.sha }} | cut -c1-7)
        echo "short_sha=$SHORT_SHA" >> $GITHUB_OUTPUT
        echo "tag_name=v${VERSION}-${SHORT_SHA}" >> $GITHUB_OUTPUT
        echo "release_name=${APP_NAME} v${VERSION} (${SHORT_SHA})" >> $GITHUB_OUTPUT
    
    - name: Create GitHub Release
      if: github.event_name == 'push' && (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master')
      uses: softprops/action-gh-release@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        tag_name: ${{ steps.version-info.outputs.tag_name }}
        name: ${{ steps.version-info.outputs.release_name }}
        body: |
          ### ðŸš€ DataSell Android App
          
          **Version**: ${{ steps.version-info.outputs.version }}
          **Build**: ${{ steps.version-info.outputs.short_sha }}
          **Date**: ${{ steps.version-info.outputs.build_date }}
          
          ### ðŸ“¦ Downloads
          - **Release APK**: Signed for production
          - **Debug APK**: For testing
          
          *Automatically built with GitHub Actions*
        prerelease: false
        draft: false
        files: |
          dist/debug/*.apk
          dist/release/*.apk
          wrapper/dist/debug/*.apk
          wrapper/dist/release/*.apk
        generate_release_notes: false
