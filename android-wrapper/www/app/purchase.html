<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="/css/responsive.css">
    <title>Buy Data - DataSell</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/notyf@3/notyf.min.css">
  <style>
    :root {
        --primary-color: #6c63ff;
        --secondary-color: #ff6584;
        --light-bg: #f8f9fa;
        --card-radius: 12px;
        --transition: all 0.3s ease;
    }

    * {
        box-sizing: border-box;
    }

    body {
        background-color: #f8f9fa;
        min-height: 100vh;
        padding-bottom: 80px;
        font-family: 'Poppins', 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif !important;
    }

    .app-header {
        background: white;
        border-bottom: 1px solid #e9ecef;
        position: sticky;
        top: 0;
        z-index: 100;
    }

    .app-title {
        font-size: 1.5rem;
        font-weight: 700;
        color: #333;
        margin: 0;
    }

    .user-avatar {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: 600;
        font-size: 0.9rem;
        background-color: var(--primary-color);
        color: white;
    }

    .app-main {
        padding: 1rem 0;
    }

    .section-title {
        font-size: 1.1rem;
        font-weight: 600;
        color: #333;
        margin-bottom: 1rem;
    }

    /* Data Pack Cards Grid */
    .packages-grid {
        display: grid;
        grid-template-columns: repeat(8, 1fr);
        gap: 0.5rem;
        margin-bottom: 2rem;
    }

    .package-card {
        background: white;
        border-radius: 8px;
        padding: 0.75rem 0.5rem;
        border: 2px solid #e9ecef;
        transition: var(--transition);
        cursor: pointer;
        box-shadow: 0 1px 4px rgba(0,0,0,0.08);
        text-align: center;
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
        min-height: 90px;
    }

    .package-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(0,0,0,0.12);
        border-color: var(--primary-color);
    }

    .package-card.selected {
        border-color: var(--primary-color);
        background: rgba(108, 99, 255, 0.1);
        box-shadow: 0 4px 12px rgba(108, 99, 255, 0.2);
    }

    .package-gb {
        font-weight: 700;
        color: #333;
        font-size: 1rem;
        margin-bottom: 0.25rem;
    }

    .package-price {
        font-size: 0.85rem;
        font-weight: 600;
        color: var(--primary-color);
        margin: 0;
    }

    .package-validity {
        font-size: 0.7rem;
        color: #6c757d;
        margin-top: 0.25rem;
    }

    .bottom-nav {
        position: fixed;
        bottom: 0;
        left: 0;
        right: 0;
        background: white;
        border-top: 1px solid #e9ecef;
        display: flex;
        padding: 0.5rem 0;
        z-index: 1000;
    }

    .nav-item {
        flex: 1;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        padding: 0.4rem;
        text-decoration: none;
        color: #6c757d;
        transition: color 200ms ease, transform 200ms ease;
        font-size: 0.75rem;
        min-height: 44px;
    }

    .nav-item i {
        transition: transform 200ms ease, color 200ms ease;
        display: block;
    }

    .nav-item.active {
        color: var(--primary-color);
        transform: translateY(-3px);
    }

    .nav-item.active i {
        transform: scale(1.12);
        color: var(--primary-color);
    }

    .nav-item i {
        font-size: 1.1rem;
        margin-bottom: 0.2rem;
    }

    .nav-item span {
        font-size: 0.7rem;
        font-weight: 500;
    }

    .nav-item:hover {
        color: var(--primary-color);
    }

    .phone-input-section {
        background: white;
        border-radius: var(--card-radius);
        padding: 1.5rem;
        margin-bottom: 1.5rem;
        box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }

    .form-label {
        font-weight: 600;
        color: #495057;
        margin-bottom: 0.5rem;
        font-size: 0.9rem;
    }

    .form-control {
        border-radius: 8px;
        padding: 0.75rem;
        border: 1px solid #e0e0e0;
        transition: var(--transition);
        font-size: 0.9rem;
        height: auto;
    }

    .form-control:focus {
        border-color: var(--primary-color);
        box-shadow: 0 0 0 0.2rem rgba(108, 99, 255, 0.25);
        outline: none;
    }

    /* Modal Styles */
    .modal-header {
        border-bottom: 1px solid #e9ecef;
        background: white;
    }

    .modal-body {
        padding: 1.5rem;
    }

    .modal-dialog {
        max-width: 400px;
    }

    .modal-content {
        border: none;
        border-radius: var(--card-radius);
        box-shadow: 0 4px 20px rgba(0,0,0,0.15);
    }

    .modal-header .btn-close {
        opacity: 0.7;
        transition: var(--transition);
    }

    .modal-header .btn-close:hover {
        opacity: 1;
    }

    .network-badge {
        display: inline-flex;
        align-items: center;
        gap: 0.5rem;
        background: white;
        padding: 0.5rem 1rem;
        border-radius: 20px;
        box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        font-weight: 600;
        margin-bottom: 1rem;
    }

    .network-badge-small {
        display: inline-flex;
        align-items: center;
        gap: 0.3rem;
        background: rgba(108, 99, 255, 0.1);
        padding: 0.3rem 0.6rem;
        border-radius: 4px;
        font-weight: 500;
        font-size: 0.7rem;
        color: var(--primary-color);
        margin-bottom: 0.4rem;
    }

    .network-badge-small img {
        width: 16px;
        height: 16px;
        object-fit: contain;
    }

    .package-features {
        display: none;
    }

    .feature {
        display: none;
    }

    .form-text {
        font-size: 0.8rem;
        color: #6c757d;
        margin-top: 0.25rem;
    }

    .payment-section {
        background: white;
        border-radius: var(--card-radius);
        padding: 1.5rem;
        margin-bottom: 1.5rem;
        box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }

    .payment-options {
        display: flex;
        gap: 1rem;
        margin-bottom: 1rem;
    }

    .payment-option {
        flex: 1;
        text-align: center;
        padding: 1rem;
        border: 2px solid #e9ecef;
        border-radius: 8px;
        cursor: pointer;
        transition: var(--transition);
        min-height: 100px;
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
    }

    .payment-option.selected {
        border-color: var(--primary-color);
        background: rgba(108, 99, 255, 0.05);
    }

    .payment-option i {
        font-size: 1.5rem;
        margin-bottom: 0.5rem;
        color: var(--primary-color);
    }

    .payment-option .payment-label {
        font-weight: 600;
        color: #333;
        font-size: 0.9rem;
    }

    .payment-option .payment-desc {
        font-size: 0.8rem;
        color: #6c757d;
        margin: 0;
        line-height: 1.3;
    }

    .payment-option-modal {
        padding: 0.8rem;
        border: 2px solid #e9ecef;
        border-radius: 6px;
        transition: var(--transition);
        text-align: center;
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
        cursor: pointer;
    }

    .payment-option-modal i {
        font-size: 1.3rem;
        margin-bottom: 0.3rem;
        color: var(--primary-color);
    }

    .payment-option-modal:hover {
        border-color: var(--primary-color);
        background: rgba(108, 99, 255, 0.05);
    }

    .payment-option-modal.selected {
        border-color: var(--primary-color);
        background: rgba(108, 99, 255, 0.1);
        box-shadow: 0 2px 8px rgba(108, 99, 255, 0.15);
    }

    .purchase-btn {
        background-color: var(--primary-color);
        border-color: var(--primary-color);
        padding: 0.75rem;
        border-radius: 12px;
        font-weight: 600;
        font-size: 1rem;
        transition: var(--transition);
        width: 100%;
        color: white;
        margin-top: 1rem;
        border: none;
        min-height: 48px;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 0.5rem;
    }

    .purchase-btn:hover:not(:disabled) {
        background-color: #5a52d5;
        border-color: #5a52d5;
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(108, 99, 255, 0.3);
    }

    .purchase-btn:disabled {
        background-color: #6c757d;
        border-color: #6c757d;
        transform: none;
        cursor: not-allowed;
        opacity: 0.7;
    }

    .direct-pay-btn {
        background-color: #00a859;
        border-color: #00a859;
    }

    .direct-pay-btn:hover:not(:disabled) {
        background-color: #008e4a;
        border-color: #008e4a;
        box-shadow: 0 4px 12px rgba(0, 168, 89, 0.3);
    }

    .wallet-info {
        background: rgba(108, 99, 255, 0.1);
        border: 1px solid rgba(108, 99, 255, 0.2);
        border-radius: var(--card-radius);
        padding: 1rem;
        margin-bottom: 1rem;
        text-align: center;
    }

    .wallet-balance {
        font-size: 1.2rem;
        font-weight: 700;
        color: var(--primary-color);
        margin: 0;
    }

    .wallet-label {
        font-size: 0.9rem;
        color: #6c757d;
        margin: 0;
    }

    .loading-spinner {
        display: inline-block;
        width: 20px;
        height: 20px;
        border: 2px solid #f3f3f3;
        border-radius: 50%;
        border-top-color: var(--primary-color);
        animation: spin 1s ease-in-out infinite;
    }

    @keyframes spin {
        to { transform: rotate(360deg); }
    }

    .package-features {
        display: flex;
        gap: 1rem;
        margin-top: 0.5rem;
        flex-wrap: wrap;
    }

    .feature {
        display: flex;
        align-items: center;
        gap: 0.25rem;
        font-size: 0.8rem;
        color: #6c757d;
    }

    .feature i {
        color: var(--primary-color);
    }

    .form-text {
        font-size: 0.8rem;
        color: #6c757d;
        margin-top: 0.25rem;
    }

    /* Mobile Styles */
    @media (max-width: 576px) {
        .container {
            padding-left: 0.75rem;
            padding-right: 0.75rem;
        }
        
        .app-title {
            font-size: 1.3rem;
        }
        
        .user-avatar {
            width: 36px;
            height: 36px;
            font-size: 0.8rem;
        }

        /* 4 columns on mobile */
        .packages-grid {
            grid-template-columns: repeat(4, 1fr);
            gap: 0.4rem;
        }

        .package-card {
            padding: 0.5rem 0.3rem;
            min-height: 80px;
        }

        .package-gb {
            font-size: 0.9rem;
        }

        .package-price {
            font-size: 0.8rem;
        }

        .package-validity {
            font-size: 0.65rem;
        }
        
        .phone-input-section {
            padding: 1rem;
        }
        
        .purchase-btn {
            padding: 0.75rem;
            font-size: 0.9rem;
            min-height: 44px;
        }
        
        .form-control {
            padding: 0.7rem;
            font-size: 16px; /* Prevent zoom on iOS */
        }
        
        .wallet-info {
            padding: 0.75rem;
        }
        
        .wallet-balance {
            font-size: 1.1rem;
        }
        
        .section-title {
            font-size: 1rem;
        }

        .modal-dialog {
            max-width: 90vw;
        }
    }

    /* Small Mobile Devices (320px) */
    @media (max-width: 375px) {
        .packages-grid {
            grid-template-columns: repeat(4, 1fr);
            gap: 0.3rem;
        }

        .package-card {
            padding: 0.4rem 0.2rem;
            min-height: 75px;
        }

        .package-gb {
            font-size: 0.85rem;
        }

        .package-price {
            font-size: 0.75rem;
        }

        .package-validity {
            font-size: 0.6rem;
        }
        
        .phone-input-section {
            padding: 0.75rem;
        }
        
        .purchase-btn {
            padding: 0.65rem;
            font-size: 0.85rem;
        }
        
        .form-label {
            font-size: 0.9rem;
        }

        .modal-dialog {
            max-width: 95vw;
        }

        .modal-body {
            padding: 1rem;
        }
    }

    /* Tablet Styles (577px - 768px) */
    @media (min-width: 577px) and (max-width: 768px) {
        .container {
            padding-left: 1rem;
            padding-right: 1rem;
        }
        
        /* 6 columns on tablet */
        .packages-grid {
            grid-template-columns: repeat(6, 1fr);
            gap: 0.5rem;
        }

        .package-card {
            min-height: 85px;
        }
    }

    /* Desktop Styles (769px+) */
    @media (min-width: 769px) {
        /* 8 columns on desktop */
        .packages-grid {
            grid-template-columns: repeat(8, 1fr);
            gap: 0.5rem;
        }

        .package-card {
            min-height: 90px;
        }

        .package-card:hover {
            transform: translateY(-3px);
        }
    }

    /* Large Desktop (1200px+) */
    @media (min-width: 1200px) {
        .container {
            max-width: 1100px;
        }

        .packages-grid {
            gap: 0.75rem;
        }

        .package-card {
            min-height: 100px;
            padding: 1rem 0.6rem;
        }

        .package-gb {
            font-size: 1.1rem;
        }

        .package-price {
            font-size: 0.95rem;
        }

        .package-validity {
            font-size: 0.75rem;
        }
    }

    /* Safe Area Support */
    @supports(padding: max(0px)) {
        .bottom-nav {
            padding-bottom: max(0.5rem, env(safe-area-inset-bottom));
        }
        
        .container {
            padding-left: max(15px, env(safe-area-inset-left));
            padding-right: max(15px, env(safe-area-inset-right));
        }
    }

    /* Focus Styles for Accessibility */
    .package-card:focus,
    .payment-option:focus,
    .purchase-btn:focus,
    .form-control:focus {
        outline: 2px solid var(--primary-color);
        outline-offset: 2px;
    }

    /* Print Styles */
    @media print {
        .bottom-nav,
        .purchase-btn {
            display: none !important;
        }
        
        .package-card,
        .phone-input-section,
        .payment-section {
            box-shadow: none;
            border: 1px solid #ddd;
        }
    }

    /* Loading State Improvements */
    .purchase-btn:disabled .loading-spinner {
        display: inline-block !important;
    }

    /* Form Validation */
    .form-control:invalid:not(:focus):not(:placeholder-shown) {
        border-color: #dc3545;
    }

    .form-control:valid:not(:focus):not(:placeholder-shown) {
        border-color: #198754;
    }

    /* Button Group Responsiveness */
    @media (max-width: 576px) {
        .purchase-btn {
            margin-top: 0.75rem;
        }
    }
</style>
</head>
<body class="mobile-layout">
    <!-- Header -->
    <header class="app-header">
        <div class="container">
            <div class="d-flex justify-content-between align-items-center py-3">
                <a href="/" class="btn btn-sm btn-outline-secondary">
                    <i class="fas fa-arrow-left"></i>
                </a>
                <h1 class="app-title">Buy Data</h1>
                <div class="user-avatar" id="userAvatar">
                    <i class="fas fa-user"></i>
                </div>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <main class="app-main">
        <div class="container">
            <!-- Selected Network -->
            <div class="selected-network mb-3">
                <div class="network-badge" id="selectedNetwork">
                    <i class="fas fa-wifi"></i>
                    <span id="networkName">Selecting Network...</span>
                </div>
            </div>

            <!-- Wallet Info -->
            <div class="wallet-info">
                <p class="wallet-label">Available Balance</p>
                <p class="wallet-balance" id="walletBalance">
                    <span class="loading-spinner" id="balanceLoading"></span>
                    <span id="balanceText" style="display: none;">â‚µ0.00</span>
                </p>
            </div>

            <!-- Data Packages Grid -->
            <div class="packages-section mb-4">
                <h2 class="section-title">Select Data Package</h2>
                <div id="packagesList" class="packages-grid">
                    <div style="grid-column: 1/-1; text-align: center; padding: 2rem 1rem;">
                        <div class="loading-spinner" style="margin: 0 auto;"></div>
                        <p class="mt-2 text-muted">Loading packages...</p>
                    </div>
                </div>
            </div>

        </div>
    </main>

    <!-- Bottom Navigation -->
    <nav class="bottom-nav">
        <a href="/" class="nav-item">
            <i class="fas fa-home"></i>
            <span>Home</span>
        </a>
        <a href="/wallet" class="nav-item">
            <i class="fas fa-wallet"></i>
            <span>Wallet</span>
        </a>
        <a href="/orders" class="nav-item">
            <i class="fas fa-shopping-bag"></i>
            <span>Orders</span>
        </a>
        <a href="/profile" class="nav-item">
            <i class="fas fa-user"></i>
            <span>Profile</span>
        </a>
    </nav>

    <!-- Phone Number Modal -->
    <div class="modal fade" id="phoneModal" tabindex="-1" aria-labelledby="phoneModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="phoneModalLabel">
                        <i class="fas fa-phone me-2" style="color: var(--primary-color);"></i>Complete Purchase
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <!-- Package Preview -->
                    <div id="packagePreview" style="background: rgba(108, 99, 255, 0.05); padding: 1rem; border-radius: 8px; margin-bottom: 1.5rem; text-align: center;">
                        <div style="font-size: 0.85rem; color: #6c757d; margin-bottom: 0.5rem;">Selected Package</div>
                        <div style="font-size: 1.2rem; font-weight: 700; color: #333;" id="previewPackage">1GB</div>
                        <div style="font-size: 0.9rem; color: var(--primary-color); font-weight: 600; margin-top: 0.25rem;" id="previewPrice">â‚µ5.99</div>
                    </div>

                        <!-- Payment Method Selection -->
                    <form id="phoneForm">
                        <div style="margin-bottom: 1.5rem;">
                            <label class="form-label" style="font-weight: 700; margin-bottom: 0.75rem; font-size: 0.95rem;">Payment Method</label>
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 0.75rem; margin-bottom: 1rem;">
                                <div class="payment-option-modal selected" onclick="selectPaymentMethodModal('wallet')">
                                    <input type="radio" class="btn-check" name="paymentMethod" id="walletRadio" value="wallet" checked style="display: none;">
                                    <i class="fas fa-wallet"></i>
                                    <div style="font-weight: 600; color: #333; font-size: 0.85rem;">Wallet</div>
                                </div>
                                <div class="payment-option-modal" onclick="selectPaymentMethodModal('direct')">
                                    <input type="radio" class="btn-check" name="paymentMethod" id="directRadio" value="direct" style="display: none;">
                                    <i class="fas fa-credit-card"></i>
                                    <div style="font-weight: 600; color: #333; font-size: 0.85rem;">Direct Pay</div>
                                </div>
                            </div>
                        </div>

                        <!-- Phone Number Input -->
                        <div class="mb-3">
                            <label for="modalPhoneNumber" class="form-label" style="font-weight: 600;">Receiver's Number</label>
                            <input type="tel" class="form-control" id="modalPhoneNumber" placeholder="0241234567" pattern="[0-9]{10}" maxlength="10" required>
                            <small class="form-text">Enter 10-digit Ghana number (e.g., 0241234567)</small>
                        </div>

                        <!-- Purchase Button -->
                        <button type="submit" class="btn purchase-btn w-100">
                            <span id="confirmBtnText">Confirm Purchase</span>
                            <span id="confirmBtnLoading" class="loading-spinner" style="display: none; margin-left: 8px;"></span>
                        </button>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/notyf@3/notyf.min.js"></script>
    <script>
        // Initialize Notyf
        const notyf = new Notyf({
            duration: 4000,
            position: { x: 'center', y: 'top' }
        });

        let currentUser = null;
        let userBalance = 0;
        let selectedNetwork = null;
        let selectedPackage = null;
        let selectedPaymentMethod = 'wallet';
        let packages = [];
        let phoneModal = null;

        // Get URL parameters
        const urlParams = new URLSearchParams(window.location.search);
        const networkParam = urlParams.get('network');
        const verifyParam = urlParams.get('verify');
        const referenceParam = urlParams.get('reference');

        // Initialize app
        async function initializeApp() {
            try {
                // Check authentication
                const userResponse = await fetch('/api/user');
                const userResult = await userResponse.json();
                
                if (userResult.success && userResult.user) {
                    currentUser = userResult.user;
                    updateUserAvatar();
                    await loadWalletBalance();
                    
                    // Check if returning from Paystack payment
                    if (verifyParam === 'true' && referenceParam) {
                        console.log('ðŸ”„ Verifying payment...');
                        await verifyDirectPayment(referenceParam);
                    } else {
                        await initializeNetwork();
                        await loadPackages();
                        setupEventListeners();
                        
                        // Initialize modal
                        phoneModal = new bootstrap.Modal(document.getElementById('phoneModal'));
                    }
                } else {
                    window.location.href = '/login';
                }
            } catch (error) {
                console.error('Initialization error:', error);
                window.location.href = '/login';
            }
        }

        // Update user avatar
        function updateUserAvatar() {
            if (currentUser && currentUser.displayName) {
                const names = currentUser.displayName.split(' ');
                const initials = names.map(name => name[0]).join('').toUpperCase();
                document.getElementById('userAvatar').textContent = initials;
            }
        }

        // Load wallet balance
        async function loadWalletBalance() {
            try {
                const response = await fetch('/api/wallet/balance');
                const result = await response.json();
                
                if (result.success) {
                    userBalance = result.balance;
                    document.getElementById('balanceText').textContent = `â‚µ${userBalance.toFixed(2)}`;
                    document.getElementById('balanceLoading').style.display = 'none';
                    document.getElementById('balanceText').style.display = 'inline';
                }
            } catch (error) {
                console.error('Failed to load wallet balance:', error);
                document.getElementById('balanceText').textContent = 'â‚µ0.00';
                document.getElementById('balanceLoading').style.display = 'none';
                document.getElementById('balanceText').style.display = 'inline';
            }
        }

        // Initialize network selection
        function initializeNetwork() {
            if (networkParam && ['mtn', 'at'].includes(networkParam)) {
                selectedNetwork = networkParam;
                const networkName = networkParam === 'mtn' ? 'MTN' : 'AirtelTigo';
                document.getElementById('networkName').textContent = networkName;
            } else {
                // Default to MTN if no valid network in URL
                selectedNetwork = 'mtn';
                document.getElementById('networkName').textContent = 'MTN';
            }
        }

        // Load data packages
        async function loadPackages() {
            try {
                const response = await fetch(`/api/packages/${selectedNetwork}`);
                const result = await response.json();
                
                if (result.success) {
                    packages = result.packages;
                    displayPackages();
                } else {
                    throw new Error('Failed to load packages');
                }
            } catch (error) {
                console.error('Package loading error:', error);
                document.getElementById('packagesList').innerHTML = `
                    <div style="grid-column: 1/-1; text-align: center; padding: 2rem 1rem;">
                        <i class="fas fa-exclamation-triangle fa-2x text-warning mb-2" style="display: block;"></i>
                        <p class="text-muted">Failed to load packages. Please try again.</p>
                        <button class="btn btn-sm btn-primary" onclick="loadPackages()">
                            <i class="fas fa-redo me-1"></i>Retry
                        </button>
                    </div>
                `;
            }
        }

        // Display packages in grid
        function displayPackages() {
            const packagesList = document.getElementById('packagesList');
            
            if (packages.length === 0) {
                packagesList.innerHTML = `
                    <div style="grid-column: 1/-1; text-align: center; padding: 2rem 1rem;">
                        <i class="fas fa-box-open fa-2x text-muted mb-2" style="display: block;"></i>
                        <p class="text-muted">No packages available for this network.</p>
                    </div>
                `;
                return;
            }

            // Sort packages by volume
            const sortedPackages = [...packages].sort((a, b) => {
                const getVolume = (pkg) => {
                    if (pkg.name) {
                        const volumeMatch = pkg.name.match(/\d+/);
                        return volumeMatch ? parseInt(volumeMatch[0]) : 0;
                    }
                    return 0;
                };
                return getVolume(a) - getVolume(b);
            });

            packagesList.innerHTML = sortedPackages.map(pkg => {
                // Extract volume from package name
                let volume = 'â€”';
                if (pkg.name) {
                    const volumeMatch = pkg.name.match(/(\d+)\s*(GB|MB)?/i);
                    if (volumeMatch) {
                        volume = volumeMatch[1] + (volumeMatch[2] || 'GB');
                    }
                }

                // Get network logo
                const networkLogo = selectedNetwork === 'mtn' ? '/images/mtn-logo.png' : '/images/airteltigo-logo.png';
                const networkLabel = selectedNetwork === 'mtn' ? 'MTN' : 'AT';

                return `
                <div class="package-card" onclick="openPhoneModal('${pkg.id}', '${pkg.name}', ${pkg.price})">
                    <div class="network-badge-small">
                        <img src="${networkLogo}" alt="${networkLabel}" />
                        <span>${networkLabel}</span>
                    </div>
                    <div class="package-gb">${volume}</div>
                    <div class="package-price">â‚µ${pkg.price.toFixed(2)}</div>
                    <div class="package-validity">${pkg.validity || '30 days'}</div>
                </div>
                `;
            }).join('');
        }

        // Open phone modal when package is clicked
        function openPhoneModal(packageId, packageName, price) {
            // Find the package
            selectedPackage = packages.find(pkg => pkg.id === packageId);
            
            if (!selectedPackage) {
                console.error('Package not found:', packageId);
                return;
            }

            // Update preview
            document.getElementById('previewPackage').textContent = packageName;
            document.getElementById('previewPrice').textContent = `â‚µ${price.toFixed(2)}`;

            // Reset phone input
            document.getElementById('modalPhoneNumber').value = '';
            document.getElementById('phoneForm').reset();
            document.getElementById('walletRadio').checked = true;
            selectedPaymentMethod = 'wallet';

            // Show modal
            phoneModal.show();

            // Focus on phone input
            setTimeout(() => {
                document.getElementById('modalPhoneNumber').focus();
            }, 100);
        }

        // Verify direct payment from Paystack callback
        async function verifyDirectPayment(reference) {
            try {
                console.log('ðŸ” Verifying payment with reference:', reference);
                
                const response = await fetch(`/api/verify-direct-payment/${reference}`);
                const result = await response.json();

                console.log('âœ… Payment verification result:', result);

                if (result.success) {
                    notyf.success('âœ… Payment successful! Your data is being processed...');
                    
                    // Wait a moment then redirect to orders
                    setTimeout(() => {
                        window.location.href = '/orders';
                    }, 2000);
                } else {
                    // Check if it's an out of stock error
                    if (result.isOutOfStock) {
                        notyf.error('âŒ Out of Stock - Payment processed but data delivery temporarily unavailable. Please try again later.');
                        console.log('ðŸ“¦ Out of Stock - Provider has insufficient balance');
                    } else {
                        notyf.error('âŒ Payment verification failed: ' + result.error);
                    }
                    
                    // Wait then redirect back to purchase page
                    setTimeout(() => {
                        window.location.href = '/purchase';
                    }, 3000);
                }
            } catch (error) {
                console.error('Payment verification error:', error);
                notyf.error('Payment verification error: ' + error.message);
                
                setTimeout(() => {
                    window.location.href = '/purchase';
                }, 3000);
            }
        }

        // Setup event listeners
        function setupEventListeners() {
            // Handle phone form submission
            document.getElementById('phoneForm').addEventListener('submit', async (e) => {
                e.preventDefault();
                
                const phoneNumber = document.getElementById('modalPhoneNumber').value;
                const selectedRadio = document.querySelector('input[name="paymentMethod"]:checked');
                selectedPaymentMethod = selectedRadio ? selectedRadio.value : 'wallet';

                // Validate phone
                if (!/^\d{10}$/.test(phoneNumber)) {
                    notyf.error('Please enter a valid 10-digit phone number');
                    return;
                }

                // Process purchase
                if (selectedPaymentMethod === 'wallet') {
                    await purchaseWithWallet(phoneNumber);
                } else {
                    await purchaseWithDirectPayment(phoneNumber);
                }
            });

            // Handle payment method radio changes in modal
            document.querySelectorAll('input[name="paymentMethod"]').forEach(radio => {
                radio.addEventListener('change', (e) => {
                    selectedPaymentMethod = e.target.value;
                });
            });
        }

        // Purchase with wallet
        async function purchaseWithWallet(phoneNumber) {
            if (!selectedPackage || !currentUser) return;

            const confirmBtn = document.querySelector('#phoneForm button[type="submit"]');
            const confirmBtnText = document.getElementById('confirmBtnText');
            const confirmBtnLoading = document.getElementById('confirmBtnLoading');

            // Check balance
            if (userBalance < selectedPackage.price) {
                notyf.error('Insufficient balance. Please fund your wallet.');
                phoneModal.hide();
                window.location.href = '/wallet';
                return;
            }

            // Show loading
            confirmBtn.disabled = true;
            confirmBtnText.textContent = 'Processing...';
            confirmBtnLoading.style.display = 'inline-block';

            try {
                // Extract volume from package name
                let volume = '1';
                if (selectedPackage.name) {
                    const volumeMatch = selectedPackage.name.match(/\d+/);
                    if (volumeMatch) {
                        volume = volumeMatch[0];
                    }
                }

                const response = await fetch('/api/purchase-data', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        network: selectedNetwork,
                        volume: volume,
                        phoneNumber: phoneNumber,
                        amount: selectedPackage.price,
                        packageName: selectedPackage.name
                    })
                });

                const result = await response.json();

                if (result.success) {
                    console.log('âœ… Purchase successful:', result);
                    notyf.success('Data purchase successful! Your order is being processed...');
                    
                    // Update balance
                    userBalance = result.newBalance;
                    document.getElementById('balanceText').textContent = `â‚µ${userBalance.toFixed(2)}`;
                    
                    // Close modal
                    phoneModal.hide();
                    
                    // Redirect to orders page
                    console.log('ðŸ“¦ Redirecting to orders page in 2 seconds...');
                    setTimeout(() => {
                        window.location.href = '/orders';
                    }, 2000);
                } else {
                    // Check if it's an out of stock error
                    if (result.isOutOfStock) {
                        notyf.error('âŒ ' + result.error);
                        console.log('ðŸ“¦ Out of Stock - Provider has insufficient balance');
                    } else {
                        throw new Error(result.error || 'Purchase failed');
                    }
                    
                    // Reset button
                    confirmBtn.disabled = false;
                    confirmBtnText.textContent = 'Confirm Purchase';
                    confirmBtnLoading.style.display = 'none';
                }
            } catch (error) {
                console.error('Purchase error:', error);
                notyf.error(error.message);
                
                // Reset button
                confirmBtn.disabled = false;
                confirmBtnText.textContent = 'Confirm Purchase';
                confirmBtnLoading.style.display = 'none';
            }
        }

        // Purchase with direct payment
        async function purchaseWithDirectPayment(phoneNumber) {
            if (!selectedPackage || !currentUser) return;

            const confirmBtn = document.querySelector('#phoneForm button[type="submit"]');
            const confirmBtnText = document.getElementById('confirmBtnText');
            const confirmBtnLoading = document.getElementById('confirmBtnLoading');

            // Show loading
            confirmBtn.disabled = true;
            confirmBtnText.textContent = 'Initializing Payment...';
            confirmBtnLoading.style.display = 'inline-block';

            try {
                console.log('ðŸ”„ Initializing direct payment for:', {
                    amount: selectedPackage.price,
                    phoneNumber: phoneNumber,
                    network: selectedNetwork,
                    package: selectedPackage.name
                });

                // Extract volume from package name
                let volume = '1';
                if (selectedPackage.name) {
                    const volumeMatch = selectedPackage.name.match(/\d+/);
                    if (volumeMatch) {
                        volume = volumeMatch[0];
                    }
                }

                // Initialize direct payment
                const response = await fetch('/api/initialize-direct-payment', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        amount: selectedPackage.price,
                        phoneNumber: phoneNumber,
                        network: selectedNetwork,
                        packageName: selectedPackage.name,
                        volume: volume
                    })
                });

                const result = await response.json();

                console.log('ðŸ’° Server response:', result);

                if (result.status && result.data && result.data.authorization_url) {
                    console.log('âœ… Redirecting to Paystack...');
                    // Redirect to Paystack
                    window.location.href = result.data.authorization_url;
                } else if (response.ok) {
                    throw new Error(result.error || result.message || 'Failed to initialize payment');
                } else {
                    throw new Error(result.error || result.message || 'Server error');
                }
            } catch (error) {
                console.error('Direct payment error:', error);
                
                // Check if it's an out of stock error
                if (error.message && error.message.includes('Out of Stock')) {
                    notyf.error('âŒ Out of Stock - Data temporarily unavailable. Please try again later.');
                } else {
                    notyf.error('Payment failed: ' + error.message);
                }
                
                // Reset button
                confirmBtn.disabled = false;
                confirmBtnText.textContent = 'Confirm Purchase';
                confirmBtnLoading.style.display = 'none';
            }
        }

        // Select payment method from payment options (if needed for compatibility)
        function selectPaymentMethod(method) {
            selectedPaymentMethod = method;
            
            // Update UI
            document.querySelectorAll('.payment-option').forEach(option => {
                option.classList.remove('selected');
            });
            event.target.closest('.payment-option').classList.add('selected');
        }

        // Select payment method from modal
        function selectPaymentMethodModal(method) {
            selectedPaymentMethod = method;
            
            // Update radio button
            if (method === 'wallet') {
                document.getElementById('walletRadio').checked = true;
            } else {
                document.getElementById('directRadio').checked = true;
            }
            
            // Update UI
            document.querySelectorAll('.payment-option-modal').forEach(option => {
                option.classList.remove('selected');
            });
            event.currentTarget.classList.add('selected');
        }

        // Initialize app when page loads
        document.addEventListener('DOMContentLoaded', initializeApp);
    </script>
</body>
</html>